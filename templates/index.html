<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spa Locator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background-color: #f9f9f9;
    }
    h2 {
      color: #333;
      margin-bottom: 10px;
    }
    #map { 
      height: 400px; 
      width: 100%; 
      margin-top: 15px; 
      border: 1px solid #ccc; 
      border-radius: 6px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #results {
      margin-top: 15px;
      padding: 12px;
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    #results p {
      margin: 8px 0;
      padding: 8px;
      background-color: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    #results p:hover {
      background-color: #f7f7f7;
    }
    input, button {
      padding: 8px 10px;
      font-size: 14px;
      margin: 5px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <h2>Spa Locator</h2>
  <input id="location" type="text" placeholder="Enter a location" />
  <button id="searchBtn">Search</button>
  <div id="results"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("location");
      const button = document.getElementById("searchBtn");
      const resultsDiv = document.getElementById("results");

      // Initialize map
      const map = L.map("map").setView([20, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors"
      }).addTo(map);

      let markers = [];

      function clearMarkers() {
          markers.forEach(m => map.removeLayer(m));
          markers = [];
      }

      function performSearch() {
          const query = input.value.trim();
          if (!query) {
              resultsDiv.innerHTML = "";
              clearMarkers();
              return;
          }

          fetch("/search", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ location: query })
          })
          .then(res => res.json())
          .then(data => {
              resultsDiv.innerHTML = "";
              clearMarkers();

              if (!data.user) {
                  resultsDiv.innerHTML = "<p>No results found.</p>";
                  return;
              }

              // Add user marker (default Leaflet marker)
              const userLat = data.user.lat;
              const userLon = data.user.lon;
              const userMarker = L.marker([userLat, userLon])
                  .addTo(map)
                  .bindPopup("Your Location");
              markers.push(userMarker);

              // Add spa markers + results
              if (data.spas.length === 0) {
                  resultsDiv.innerHTML = "<p>No spas found nearby.</p>";
              } else {
                  resultsDiv.innerHTML = data.spas.map(spa =>
                      `<p><strong>${spa.address}</strong><br>
                      ${spa.distance} km away • ${spa.travel_time}</p>`
                  ).join("");

                  data.spas.forEach(spa => {
                      const marker = L.marker([spa.lat, spa.lon]).addTo(map)
                          .bindPopup(`<strong>${spa.address}</strong><br>${spa.distance} km<br>${spa.travel_time}`);
                      markers.push(marker);
                  });
              }

              // Fit map bounds to all markers
              const group = L.featureGroup(markers);
              map.fitBounds(group.getBounds(), { padding: [50, 50] });

          })
          .catch(err => {
              resultsDiv.innerHTML = `<p>Error: ${err.message}</p>`;
          });
      }

      // Enter key triggers search
      input.addEventListener("keyup", (event) => {
          if (event.key === "Enter") {
              performSearch();
          }
          if (input.value.trim() === "") {
              resultsDiv.innerHTML = "";
              clearMarkers();
          }
      });

      button.addEventListener("click", performSearch);
  });
  </script>
</body>
</html>
