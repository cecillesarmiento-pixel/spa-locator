<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spa Locator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 400px; width: 100%; margin-top: 10px; border: 1px solid #ccc; }
    #results {
      margin-top: 15px;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 6px;
      max-height: 250px;
      overflow-y: auto;
    }
    input, button {
      padding: 8px;
      font-size: 14px;
      margin: 5px 0;
    }
    .spa-card {
      padding: 8px;
      margin-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    .status-active { color: green; font-weight: bold; }
    .status-inactive { color: blue; font-weight: bold; }
    .status-service { color: purple; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Spa Locator</h2>
  <input id="location" type="text" placeholder="Enter a city, e.g., New York, NY" />
  <button id="searchBtn">Search</button>
  <div id="results"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("location");
      const button = document.getElementById("searchBtn");
      const resultsDiv = document.getElementById("results");

      // Initialize map
      const map = L.map("map").setView([20, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);

      let markers = [];

      function clearMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
      }

      function performSearch() {
        const query = input.value.trim();
        if (!query) {
          resultsDiv.innerHTML = "";
          clearMarkers();
          return;
        }

        fetch("/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ location: query })
        })
        .then(res => res.json())
        .then(data => {
          resultsDiv.innerHTML = "";
          clearMarkers();

          if (!data.user) {
            resultsDiv.innerHTML = "<p>No results found.</p>";
            return;
          }

          // User location marker (red)
          const userLat = data.user.lat;
          const userLon = data.user.lon;
          const userMarker = L.marker([userLat, userLon], {
            icon: L.icon({
              iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png",
              iconSize: [32,32],
              iconAnchor: [16,32],
              popupAnchor: [0,-32]
            })
          }).addTo(map).bindPopup("Your location");
          markers.push(userMarker);

          // Add spa results
          if (data.spas.length === 0) {
            resultsDiv.innerHTML = "<p>No spas found nearby.</p>";
          } else {
            data.spas.forEach(spa => {
              // Determine status color and icon
              let statusClass = "";
              let iconUrl = "";
              if (spa.status.toLowerCase() === "active") {
                statusClass = "status-active";
                iconUrl = "https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png";
              } else if (spa.status.toLowerCase() === "inactive") {
                statusClass = "status-inactive";
                iconUrl = "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png";
              } else if (spa.status.toLowerCase() === "service only") {
                statusClass = "status-service";
                iconUrl = "https://maps.gstatic.com/mapfiles/ms2/micons/purple-dot.png";
              }

              // Create spa card
              const card = document.createElement("div");
              card.classList.add("spa-card");
              card.innerHTML = `
                <strong>${spa.name}</strong> (<span class="${statusClass}">${spa.status}</span>)<br>
                ${spa.address}<br>
                ${spa.distance} miles • ${spa.travel_time}
              `;
              resultsDiv.appendChild(card);

              // Add marker on map
              const marker = L.marker([spa.lat, spa.lon], {
                icon: L.icon({
                  iconUrl: iconUrl,
                  iconSize: [32,32],
                  iconAnchor: [16,32],
                  popupAnchor: [0,-32]
                })
              }).addTo(map)
                .bindPopup(`
                  <strong>${spa.name}</strong><br>
                  ${spa.status}<br>
                  ${spa.address}<br>
                  ${spa.distance} miles • ${spa.travel_time}
                `);
              markers.push(marker);
            });
          }

          // Fit map to markers
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds(), { padding: [50,50] });
        })
        .catch(err => {
          resultsDiv.innerHTML = `<p>Error: ${err.message}</p>`;
        });
      }

      // Enter key triggers search
      input.addEventListener("keyup", (event) => {
        if (event.key === "Enter") performSearch();
        if (input.value.trim() === "") {
          resultsDiv.innerHTML = "";
          clearMarkers();
        }
      });

      button.addEventListener("click", performSearch);
    });
  </script>
</body>
</html>
