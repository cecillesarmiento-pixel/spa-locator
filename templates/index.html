<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spa Locator</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 400px; width: 100%; margin-top: 10px; border: 1px solid #ccc; }
    #results { margin-top: 10px; }
    input, button {
      padding: 8px;
      font-size: 14px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h2>Spa Locator</h2>
  <input id="location" type="text" placeholder="Enter a location" />
  <button id="searchBtn">Search</button>
  <div id="results"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("location");
      const button = document.getElementById("searchBtn");
      const resultsDiv = document.getElementById("results");

      // Initialize map
      const map = L.map("map").setView([20, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors"
      }).addTo(map);

      let markers = [];

      function clearMarkers() {
          markers.forEach(m => map.removeLayer(m));
          markers = [];
      }

      function performSearch() {
          const query = input.value.trim();
          if (!query) {
              resultsDiv.innerHTML = "";
              clearMarkers();
              return;
          }

          fetch("/search", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ location: query })
          })
          .then(res => res.json())
          .then(data => {
              resultsDiv.innerHTML = "";
              clearMarkers();

              if (!data.user) {
                  resultsDiv.innerHTML = "<p>No results found.</p>";
                  return;
              }

              // Add user marker (blue icon)
              const userLat = data.user.lat;
              const userLon = data.user.lon;
              const userIcon = L.icon({
                  iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
                  iconSize: [32, 32],
                  iconAnchor: [16, 32],
                  popupAnchor: [0, -32]
              });
              const userMarker = L.marker([userLat, userLon], { icon: userIcon })
                  .addTo(map)
                  .bindPopup("You are here");
              markers.push(userMarker);

              // Add spa markers + results
              if (data.spas.length === 0) {
                  resultsDiv.innerHTML = "<p>No spas found nearby.</p>";
              } else {
                  resultsDiv.innerHTML = data.spas.map(spa =>
                      `<p>${spa.address} - ${spa.distance} km - ${spa.travel_time}</p>`
                  ).join("");

                  data.spas.forEach(spa => {
                      const marker = L.marker([spa.lat, spa.lon]).addTo(map)
                          .bindPopup(`${spa.address}<br>${spa.distance} km<br>${spa.travel_time}`);
                      markers.push(marker);
                  });
              }

              // Fit map bounds to all markers
              const group = L.featureGroup(markers);
              map.fitBounds(group.getBounds(), { padding: [50, 50] });

          })
          .catch(err => {
              resultsDiv.innerHTML = `<p>Error: ${err.message}</p>`;
          });
      }

      // Enter key triggers search
      input.addEventListener("keyup", (event) => {
          if (event.key === "Enter") {
              performSearch();
          }
          if (input.value.trim() === "") {
              resultsDiv.innerHTML = "";
              clearMarkers();
          }
      });

      button.addEventListener("click", performSearch);
  });
  </script>
</body>
</html>
